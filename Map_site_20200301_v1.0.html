<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Visualising conflict</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <!This script brings in mapbox>
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js"></script>
	
    <!This script brings in mapbox stylesheet (css)>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css" rel="stylesheet" />
    
    <!Style of the page>
    <style>
	   body { margin: 0; padding: 0; }
	   #map { position: absolute; top: 0; bottom: 0; width: 75%; };
    </style>
</head>

<!Body of the site>
<body>
<div id="map"></div>
    
<script>
    //Access token for AF
	mapboxgl.accessToken = 'pk.eyJ1IjoiYW50b25pb3NmaWFsYSIsImEiOiJjazVwOGlqNTQwbDh4M21ucmtrbDRuZXN3In0.EMqc-rodA-MlAAhtQ7A7GQ';
    
    //global parameters
    var centre_lat = 30;
    var centre_long = 46;
    
    var zoom_start = 4;
    var zoom_max = 13.5;
    
    //Colour palettes (5 colours)
    var colour1 = [];
    var colour2 = [];
    var colour3 = [];
    
    //data parameters
    //load geojson and get max/mins of columns
    
    
    //Calculate centroid based on geo-extent

    var calculated_centroid = 0;
    
    var GeoJsonURL = "https://antoniosfiala.github.io/UCL_DV/ManualGJ2.geojson";
    
    
    //Create new instance of a mapbox maps with relevant style sheet (outdoor map)
	var map = new mapboxgl.Map({
		container: 'map', // container id
		style: 'mapbox://styles/antoniosfiala/ck795kiuw3hdn1inthwitl2ju', // stylesheet location
		center: [centre_long, centre_lat], // starting position [lng, lat]
		zoom: zoom_start // starting zoom
	});
    
    //Create an on load function to load in data
    map.on('load', function() {
        
        //Add source data from local .geojson
        //GeoJson obtained by converting ACLED .csv to GeoJson
        map.addSource('acled', {
            'type': 'geojson',
            'data': GeoJsonURL
            //"./Dataset/ManualGJ2.geojson"
            }
        );
        
        //Add heatmap data to map        
        map.addLayer({
            'id':'Event_heat',
            'type': 'heatmap',
            'source': 'acled',
            'maxzoom': zoom_max,
            'paint': {
                //FOLLOW THIS https://docs.mapbox.com/help/tutorials/make-a-heatmap-with-mapbox-gl-js/
                //Code to affect heatmap weight based on frequency
                
                //Weighting of each point
                'heatmap-weight': {
                    property: 'fat_extra',
                    type: 'exponential',
                    stops: [
                        [1,0],
                        [177,1]
                    ]
                },
                
                //Intensity, helps smoothen across zoom levels
                'heatmap-intensity':{
                    stops: [
                        //[zoom level, intensity level]
                        //gaps get scaled
                        [zoom_start,1],
                        [10,1],
                        [zoom_max,1]
                    ]
                },
                
                //Colour - red hues
                'heatmap-color': [
                    'interpolate',
                    ['linear'],
                    ['heatmap-density'],
                    //different densities between 0-1 get different colours
                    //this is almost like a 'filter' layer
                    0,      'rgba(253,141,60,0)',
                    //breakpoints for actual colours
                    0.00001,    'rgba(254,204,92,0.8)',
                    0.5,    'rgba(253,141,60,1)',
                    0.85,   'rgba(240,59,32,1)',
                    1.0,    'rgba(189,0,38,1)'
                ],
                
                //Radius as zoom increases
                'heatmap-radius': {
                    stops: [
                        //[zoom,radius]
                        [zoom_start,4],
                        [12,20],
                        [zoom_max,30]
                    ]
                },
                
                //Opacity, do for whole layer rather than with colours
                'heatmap-opacity':{
                    default: 0.75,
                    stops:[
                        [zoom_max-1,0.75],
                        [zoom_max,0]
                    ]
                },
                //Nothing else to add for now
            }
                
        },'waterway-label'); //closes layer
        
        map.addLayer({
            id: 'Event-point',
            type: 'circle',
            source: 'acled',
            minzoom: 9.75,
            
            paint:{
                'circle-radius': 7,
                
                'circle-color': {
                    property: 'event_type',
                    type: 'categorical',
                    stops:[
                        ['Protests','rgba(102,194,165,0.8)'],
                        ['Battles','rgba(252,141,98,0.8)'],
                        ['Riots','rgba(141,160,203,0.8)'],
                        ['Violence against civilians','rgba(231,138,195,0.8)'],
                        ['Strategic developments','rgba(166,216,84,0.8)'],
                        ['Explosions/Remote violence','rgba(255,217,47,0.8)'],
                        
                    ]
                },
                'circle-stroke-color': 'black',
                'circle-stroke-width': 0.5,
                'circle-opacity': {
                    default: 0,
                    stops: [
                        [10,0],
                        [zoom_max,0.5],
                        [zoom_max+1,1]
                    ]
                }
            }
        },'waterway-label'); //closes layer
    
    });
    
    //for development - report back zoom level
    map.on('click', function(){
        var zoom = map.getZoom();
        console.log(zoom);   
           });
    
    map.on('click', 'Event-point',function(e) {
        new mapboxgl.Popup().setLngLat(e.features[0].geometry.coordinates).setHTML('<b>Event type:</b> ' + e.features[0].properties.event_type + '<b><br/>Date:</b> ' + e.features[0].properties.event_date).addTo(map);
    });
    
    

</script>

</body>
</html>

//https://docs.mapbox.com/help/tutorials/show-changes-over-time/